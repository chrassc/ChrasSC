<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <title>Kor Alert</title>
  <!-- 8l1v1v8ltg -->
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=8l1v1v8ltg"></script>
  <script type="text/javascript"
    src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=8l1v1v8ltg&submodules=geocoder"></script>
  <script type="text/javascript" src="assets/js/MarkerClustering.js"></script>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jquery.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>
</head>

<body>
  <!-- Header -->
  <header id="header">
    <a class="logo" href="index.html">ChrasSC Industries</a>
    <nav>
      <a href="#menu">Menu</a>
    </nav>
  </header>
  <!-- Nav -->
  <nav id="menu">
    <ul class="links">
      <li><a href="index.html">Home</a></li>
      <li><a href="elements.html">Elements</a></li>
      <li><a href="aboutus.html">About Us</a></li>
      <li><a href="koralert.html">Korea Alert System</a></li>
    </ul>
  </nav>
  <div id="demo">
    <h1>CBS Request</h1>
    <button type="button" id="button" onclick="sendQuery()">Send Query</button>
    <button type="button" id="button2" onclick="nextTask()">Next Task</button>
  </div>
  <div id="map" style="width:100%;height:800px;"></div>
  <div class="content">
    <table id="table">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Location</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <script>
    var gVarTest;
    
    //initialize new Naver Map to div #map
    var map = new naver.maps.Map("map", {
      center: new naver.maps.LatLng(36.55753, 127.75409),
      zoom: 8,
      mapTypeControl: true,
      zoomControl: true,
      zoomControlOptions: {
        position: naver.maps.Position.TOP_LEFT,
        style: naver.maps.ZoomControlStyle.SMALL
      }
    })
    //markers and info windows that display information when markers are clicked (see attachInfoToMarkers())
    var markers = [];
    var infoWindows = [];
    //visible area of map from NW to SE
    var bounds = map.getBounds();
    var northEast = bounds.getNE();
    var southWest = bounds.getSW();
    var lngSpan = northEast.lng() - southWest.lng();
    var latSpan = northEast.lat() - southWest.lat();

    //adds event listener to update markers on the map upon changes to map
    naver.maps.Event.addListener(map, 'idle', function () { updateMarkers(map, markers); });

    //receives markers from markers array and updates on map
    function updateMarkers(map, markers) {
      let marker;
      let position;
      let i = 0;
      for (i in markers) {
        marker = markers[i];
        position = marker.getPosition();
        if (bounds.hasLatLng(position)) {
          showMarker(map, marker);
        }
        else {
          hideMarker(map, marker);
        }
      }
    }
    //see fx updateMarkers
    function showMarker(map, marker) {

      if (marker.setMap()) return;
      marker.setMap(map);
    }
    //see fx updateMarkers
    function hideMarker(map, marker) {

      if (!marker.setMap()) return;
      marker.setMap(null);
    }
    // Return an event handler storing the marker index as a closure variable named seq.
    function getClickHandler(seq) {
      return function (e) {
        var marker = markers[seq],
          infoWindow = infoWindows[seq];

        if (infoWindow.getMap()) {
          infoWindow.close();
        } else {
          infoWindow.open(map, marker);
        }
      }
    }

    //assign each marker with its respective infoWindow
    function attachInfoToMarkers() {
      for (let i = 0, ii = markers.length; i < ii; i++) {
        naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
      }
    }



    let url = "https://naveropenapi.apigw.ntruss.com/map-geocode/v2/geocode";
      let id = "8l1v1v8ltg";
      let key = "h54A6C6Ndio4LYulVxT2FGYaGCiD3QjwH8l91sQU";
      let query = object.location_name;
      //modify above as needed, do not change below unless header keys change
      let queryHeader = url + "?" + encodeURIComponent("X-NCP-APIGW-API-KEY-ID") + "=" + encodeURIComponent(id);
      queryHeader += "&" + encodeURIComponent("X-NCP-APIGW-API-KEY") + "=" + encodeURIComponent(key);
      queryHeader += "&" + encodeURIComponent("query") + "=" + encodeURIComponent(query);



    let ajaxHeaders = {
      GIS: {
        url: "http://apis.data.go.kr/1741000/DisasterMsg2/getDisasterMsgList",
        headers: {
          "Service Key": "aN2aOKkivRPAL7ZlAtz6BKj%2FQcSYUvEvZVRk80qX0cTYMUEUAiGIx%2BslDNoLo1feNuxD6cSBgSaMO3B6tp%2FZvw%3D%3D",
          "PageNo": "1",
          "numOfRows": "10",
          "type": "JSON",
          "flag": "Y"
        }
      },
      geocacher: {
        url: "https://naveropenapi.apigw.ntruss.com/map-geocode/v2/geocode",
        headers: {
          "X-NCP-APIGW-API-KEY-ID": "8l1v1v8ltg",
          "X-NCP-APIGW-API-KEY": "h54A6C6Ndio4LYulVxT2FGYaGCiD3QjwH8l91sQU",
          "query": ""
        }

      }
    }
    //INCOMPLETE begin AJAX with url and header
    var ajaxCall = function(url, headers) {
      return $.ajax({
        url: url,
        header: headers,
        data: JSON.parse(data),
        success: function 
      });
    }
//       let promise = new Promise(function (resolve, reject) {
//         let xhr = new XMLHttpRequest();
//         let response;
//         xhr.open("GET", url);
//         xhr.onload = function () {
//           if (this.readyState == 4 && this.status == 200) {
//             response = JSON.parse(this.responseText);
//             resolve(response);
// //            console.log("response: " + response);
//           }
//           else {
//             response = "error";
//             reject(response)
//             console.log("error in ajaxCall()")
//           }
//         }
//         xhr.send();
//       });


    //ajax call for GIS data
    function sendGIS() {
      let url = "http://apis.data.go.kr/1741000/DisasterMsg2/getDisasterMsgList";
      let sKey = "aN2aOKkivRPAL7ZlAtz6BKj%2FQcSYUvEvZVRk80qX0cTYMUEUAiGIx%2BslDNoLo1feNuxD6cSBgSaMO3B6tp%2FZvw%3D%3D";
      let pageNo = 1;
      let numOfRows = 10;
      let type = "JSON";
      let flag = "Y";
      //modify above as needed, do not change below unless header keys change
      let queryHeader = url + "?" + encodeURIComponent("ServiceKey") + "=" + sKey;
      queryHeader += "&" + encodeURIComponent("pageNo") + "=" + encodeURIComponent(pageNo);
      queryHeader += "&" + encodeURIComponent("numOfRows") + "=" + encodeURIComponent(numOfRows);
      queryHeader += "&" + encodeURIComponent("type") + "=" + encodeURIComponent(type);
      queryHeader += "&" + encodeURIComponent("flag") + "=" + encodeURIComponent(flag);
      return queryHeader;
      // let GISData = await ajaxCall(queryHeader);
      // console.log(GISData);
        // .then(function () {
        // for (i in value.DisasterMsg[1].row){
        //   let tBodyRef = document.getElementById("table").getElementsByTagName("tbody")[0];
        //   let row = tBodyRef.insertRow();
        //   let cell1 = row.insertCell(0);
        //   let cell2 = row.insertCell(1);
        //   let cell3 = row.insertCell(2);
        //   cell1.innerHTML = cbsInfo[i].create_date;
        //   cell2.innerHTML = cbsInfo[i].location_name;
        //   cell3.innerHTML = cbsInfo[i].msg;
        // }
        // });

    }

    //ajax call for Naver MAPS geocacher, uses object returned from GIS data and converts location_name to lat and lng
    function sendMapGeocache(object) {
      let url = "https://naveropenapi.apigw.ntruss.com/map-geocode/v2/geocode";
      let id = "8l1v1v8ltg";
      let key = "h54A6C6Ndio4LYulVxT2FGYaGCiD3QjwH8l91sQU";
      let query = object.location_name;
      //modify above as needed, do not change below unless header keys change
      let queryHeader = url + "?" + encodeURIComponent("X-NCP-APIGW-API-KEY-ID") + "=" + encodeURIComponent(id);
      queryHeader += "&" + encodeURIComponent("X-NCP-APIGW-API-KEY") + "=" + encodeURIComponent(key);
      queryHeader += "&" + encodeURIComponent("query") + "=" + encodeURIComponent(query);
      return queryHeader;
    }

    function sendQuery() {
      document.getElementById("table").removeChild(document.getElementById("table").children[1]);
      document.getElementById("table").appendChild(document.createElement("tbody"));
      ajaxCall(sendGIS()).then(resolve => {
        GISData = resolve.DisasterMsg[1].row;
        gVarTest = GISData;
        console.log(gVarTest);
      })
      document.getElementById("button").innerText = "Resend Query";
    }
  </script>
</body>

</html>